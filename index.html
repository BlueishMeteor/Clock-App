<script>
  // Firebase config (your existing config)
  const firebaseConfig = {
    apiKey: "AIzaSyD056thmGLxTwVOU01Qy_KNIqS4aqdW8Bw",
    authDomain: "clockapp-26b10.firebaseapp.com",
    projectId: "clockapp-26b10",
    storageBucket: "clockapp-26b10.firebasestorage.app",
    messagingSenderId: "381529267609",
    appId: "1:381529267609:web:3b6565b1b60c2c72acc708",
    measurementId: "G-SX7DKY8WPQ"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let sections = [];
  let currentSection = 0;
  let timer = null;
  let timeLeft = 0;
  let isRunning = false;
  let dragStartIndex = null;

  function format(seconds) {
    const m = Math.floor(Math.abs(seconds) / 60);
    const s = Math.abs(seconds) % 60;
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  function updateDisplay() {
    const timerEl = document.getElementById("timer");
    const overrunEl = document.getElementById("overrun");
    if (timeLeft >= 0) {
      timerEl.textContent = format(timeLeft);
      timerEl.style.color = "#22c55e";
      overrunEl.textContent = "";
    } else {
      timerEl.textContent = "00:00";
      timerEl.style.color = "#ef4444";
      overrunEl.textContent = `Overrun: ${format(Math.abs(timeLeft))}`;
    }
    updateProgressBar();
    updateRemainingTime();
    updateTotalAndEnd();
  }

  function updateProgressBar() {
    const total = sections[currentSection]?.duration || 1;
    const remaining = Math.max(timeLeft, 0);
    const percent = ((total - remaining) / total) * 100;
    const progressBar = document.getElementById("progress-bar");
    progressBar.style.width = `${percent}%`;

    if (percent < 50) {
      progressBar.style.backgroundColor = "#22c55e";
    } else if (percent < 80) {
      progressBar.style.backgroundColor = "#facc15";
    } else {
      progressBar.style.backgroundColor = "#ef4444";
    }
  }

  function updateTitle() {
    const titleEl = document.getElementById("section-title");
    if (sections[currentSection]) {
      titleEl.textContent = sections[currentSection].name;
    } else {
      titleEl.textContent = "Church Schedule Timer";
    }
  }

  function updateRemainingTime() {
    const remainingTimeEl = document.getElementById("remaining-time");
    let remainingSeconds = timeLeft;
    for (let i = currentSection + 1; i < sections.length; i++) {
      remainingSeconds += sections[i].duration;
    }
    remainingTimeEl.textContent = "Remaining Schedule Time: " + format(remainingSeconds);
  }

  function updateTotalAndEnd() {
    const totalTimeEl = document.getElementById("total-time");
    const predictedEndEl = document.getElementById("predicted-end");

    let totalSeconds = sections.reduce((acc, s) => acc + s.duration, 0);
    totalTimeEl.textContent = "Total Schedule Time: " + format(totalSeconds);

    const now = new Date();
    const predictedEnd = new Date(now.getTime() + totalSeconds * 1000);
    predictedEndEl.textContent = "Predicted End: " + predictedEnd.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function saveState() {
    database.ref('timerState').set({
      secretKey: 'PickAllPokemons98',
      sections,
      currentSection,
      timeLeft,
      isRunning,
    });
  }

  function loadState() {
    database.ref('timerState').on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      if (data.secretKey !== 'PickAllPokemons98') {
        console.warn("Invalid secret key in data; ignoring update.");
        return;
      }
      sections = data.sections || [];
      currentSection = data.currentSection ?? 0;
      timeLeft = data.timeLeft ?? (sections[currentSection]?.duration || 0);
      isRunning = data.isRunning || false;

      renderSections();
      updateDisplay();
      updateTitle();

      if (isRunning) {
        startTimer(false);
      } else {
        pauseTimer(false);
      }
    });
  }

  function startTimer(save = true) {
    if (!sections[currentSection] || isRunning) return;
    if (timeLeft <= 0) {
      timeLeft = sections[currentSection].duration;
      updateDisplay();
    }
    isRunning = true;
    clearInterval(timer);
    timer = setInterval(() => {
      timeLeft--;
      updateDisplay();
      if (save) saveState();
      if (timeLeft < -600) pauseTimer(save); // auto pause after 10 min overrun
    }, 1000);
    if (save) saveState();
  }

  function pauseTimer(save = true) {
    isRunning = false;
    clearInterval(timer);
    if (save) saveState();
  }

  function resetTimer(save = true) {
    pauseTimer(save);
    if (sections[currentSection]) {
      timeLeft = sections[currentSection].duration;
    } else {
      timeLeft = 0;
    }
    updateDisplay();
    updateTitle();
    if (save) saveState();
  }

  function nextSection() {
    if (currentSection < sections.length - 1) {
      currentSection++;
      // Don't reset timeLeft to full duration here; keep current remaining time
      // Just update UI and keep timer running if it was running
      updateTitle();
      renderSections();
      if (isRunning) {
        // Timer continues counting down from the current timeLeft
        // No need to reset timer interval because it is running
        updateDisplay();
      } else {
        updateDisplay();
      }
      saveState();
    }
  }

  function previousSection() {
    if (currentSection > 0) {
      currentSection--;
      updateTitle();
      renderSections();
      updateDisplay();
      saveState();
    }
  }

  function addSection() {
    const name = document.getElementById("section-name").value.trim();
    const minutes = parseInt(document.getElementById("minutes").value) || 0;
    const seconds = parseInt(document.getElementById("seconds").value) || 0;
    const duration = minutes * 60 + seconds;
    if (!name || duration <= 0) return;
    sections.push({ name, duration });
    renderSections();
    updateTitle();
    document.getElementById("section-name").value = "";
    document.getElementById("minutes").value = "";
    document.getElementById("seconds").value = "";
    saveState();
  }

  function removeSection(index) {
    if (isRunning) return;
    sections.splice(index, 1);
    if (currentSection === index) {
      currentSection = 0;
      timeLeft = 0;
      updateDisplay();
    } else if (currentSection > index) {
      currentSection--;
    }
    renderSections();
    updateTitle();
    saveState();
  }

  function renderSections() {
    const list = document.getElementById("section-list");
    list.innerHTML = "";
    sections.forEach((s, i) => {
      const div = document.createElement("div");
      div.className = "section-item";
      div.setAttribute("draggable", true);
      div.setAttribute("data-index", i);
      div.ondragstart = dragStart;
      if (i === currentSection) div.classList.add("active");
      div.innerHTML = `
        <span>${s.name} (${format(s.duration)})</span>
        <button class="remove-btn" onclick="removeSection(${i})">X</button>
      `;
      list.appendChild(div);
    });
    updateTitle();
  }

  function dragStart(e) {
    dragStartIndex = +e.target.getAttribute("data-index");
  }

  function dropSection(e) {
    const dropTarget = e.target.closest(".section-item");
    if (!dropTarget) return;
    const dropIndex = +dropTarget.getAttribute("data-index");
    const item = sections.splice(dragStartIndex, 1)[0];
    sections.splice(dropIndex, 0, item);
    if (currentSection === dragStartIndex) currentSection = dropIndex;
    else if (currentSection > dragStartIndex && currentSection <= dropIndex) currentSection--;
    else if (currentSection < dragStartIndex && currentSection >= dropIndex) currentSection++;
    renderSections();
    saveState();
  }

  function toggleMenu() {
    const menu = document.getElementById("menu-section");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  // Initialize with default sections if empty
  function init() {
    if (sections.length === 0) {
      sections = [
        { name: "Song 1", duration: 180 },
        { name: "Song 2", duration: 240 },
        { name: "Song 3", duration: 300 }
      ];
      currentSection = 0;
      timeLeft = sections[0].duration;
      saveState();
    }
    renderSections();
    updateDisplay();
    updateTitle();
  }

  window.onload = () => {
    loadState();
    setTimeout(() => {
      if (sections.length === 0) {
        init();
      }
    }, 2000);
  };
</script>
